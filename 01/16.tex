\subsection{%
  Иерархическая кластеризация.%
}

\begin{definition}
  Иерархическая кластеризация это построение иерархии (дерева) кластеров.
\end{definition}

Для визуализации результатов используется дендрограмма~--- дерево, построенное
по матрице расстояний между кластерами. В узлах дерева находятся подмножества
объектов из обучающей выборки. Объединения узлов между ярусами дендрограммы
соответствует объединению кластеров.

\textbf{Алгоритмы WPGMA/UPGMA}:

\underline{Задача}: построить дерево по матрице расстояний между листьями.

\begin{definition}
  Ультраметричность~--- следующее свойство: \(d_{xy} \le \max(d_{xz}, d_{yz})\),
  где \(x, y, z\) - листья в полученном дереве, а \(d_{xy}\) это расстояние
  между листьями \(x\) и \(y\).
\end{definition}

\begin{remark}
  Полученное дерево уникальное и обладает свойством ультраметричности.
\end{remark}

\underline{Алгоритм}:
\begin{enumerate}
  \item Ищем две ближайшие вершины \(x\) и \(y\).
  
  \item В результирующее дерево добавляем вершину \(u\), которая родителем для
  двух этих вершин.
  
  \item Вычисляем веса ребер:
  \(\dist{u, x} = \dist{u, y} = \frac{1}{2} \cdot \dist{x, y}\).

  \item Обновляем матрицу расстояний: убираем из неё \(x\), \(y\) и добавляем
  \(u\). 

  \item Теперь необходимо пересчитать расстояния. В зависимости от алгоритма
  будут разные формулы пересчета:

  \begin{multicols}{2}
    \begin{enumerate}  
      \item WPGMA
    
      Расстояние от кластера до вершины равно среднему арифметическому
      расстояний от каждой компоненты кластера до этой вершины:
      
      \begin{align*}
        u = (x, y) \\
        \dist{u, z} = \frac{1}{2} \cdot (\dist{z, x} + \dist{z, y})
      \end{align*}

      \columnbreak
      
      \item UPGMA
      
      Чтобы найти расстояние от кластера до вершины нужно умножить расстояние
      от вершины до каждой из компонент кластера на размер этой компоненты.
      Результаты нужно сложить, после чего поделить на количество вершин в
      кластере

      \begin{align*}
        u = (xy, z) \\
        \dist{u, w} = \frac{1}{2 + 1} (
          \dist{xy, w} \cdot 2 + \dist{z, w} \cdot 1
        )
      \end{align*}
    \end{enumerate}

  \end{multicols}

  \item Будем повторять шаги \(1-5\) пока матрица не сожмется в одну ячейку.
\end{enumerate}

\begin{remark}
  В алгоритме UPGMA можно пересчитывать расстояния от вершин до кластера
  по-другому: можно взять среднее из расстояний от рассматриваемой вершины до
  каждой из вершин кластера:
  
  \begin{align*}
    u = (xy, z) \implies
    \dist{u, w} = \frac{1}{3} (\dist{x, w} + \dist{y, w} + \dist{z, w})
  \end{align*}
  
  Результат будет такой же, но потребуется дополнительно хранить исходную
  матрицу расстояний.
\end{remark}
